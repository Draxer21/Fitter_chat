<div class="container" style="max-width: 1200px; margin: 0 auto;">
  <div class="alert" role="alert" style="background-color: rgba(0, 0, 0, 0.904);">
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th scope="row" colspan="5" class="text-center">CARRITO</th>
          </tr>
          <tr>
            <th scope="col">NOMBRE</th>
            <th scope="col">CANTIDAD</th>
            <th scope="col">PRECIO UNITARIO</th>
            <th scope="col">PRECIO TOTAL DEL PRODUCTO</th>
            <th scope="col">ELIMINAR/AGREGAR</th>
          </tr>
        </thead>
        <tbody>
          {% if request.session.carrito.items %}
          {% for key, value in request.session.carrito.items %}
          <tr>
            <td>{{value.nombre}}</td>
            <td>{{value.cantidad}}</td>
            <td>$ {{value.precio_unitario}}</td>
            <td>$ {{value.acumulado}}</td>
            <td>
              <a href="{% url 'Sub' value.producto_id %}" class="badge btn btn-dark badge-dark">-</a>
              <a href="{% url 'Add' value.producto_id %}" class="badge btn btn-dark badge-dark">+</a>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="5">
              <div class="alert alert-danger text-center"> Sin Productos </div>
            </td>
          </tr>
          {% endif %}
          <tr>
            <th scope="row">Total:</th>
            <td colspan="4">$ {{total_carrito}}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <hr>
  </div>
  <div class="row text-center">
    <div class="col-6">
      <a href="{% url 'CLS' %}" class="btn btn-danger">Limpiar</a>
    </div>
    <div class="col-6">
      <button id="hacer-compra" type="submit" class="btn btn-success">Hacer Compra</button>
    </div>
  </div>
</div>
<script>
  document.getElementById("hacer-compra").addEventListener("click", function(event) {
      event.preventDefault();

      // Obtener información del usuario de la sesión o solicitar
      const userName = "{{ request.session.get('full_name', '') }}" || prompt("Ingresa tu nombre completo:");
      const userEmail = "{{ request.session.get('email', '') }}" || prompt("Ingresa tu email:");

      if (!userName || !userEmail) {
          Swal.fire({
              title: "Datos incompletos",
              text: "Necesitamos tu nombre y email para procesar la compra",
              icon: "warning",
              confirmButtonText: "OK"
          });
          return;
      }

      // Mostrar loading
      Swal.fire({
          title: 'Procesando...',
          text: 'Creando tu orden de compra',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
              Swal.showLoading();
          }
      });

      // Llamar al endpoint de pago
      fetch("/carrito/pagar", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify({
              name: userName,
              email: userEmail
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.error) {
              Swal.fire({
                  title: "Error",
                  text: data.error,
                  icon: "error",
                  confirmButtonText: "OK"
              });
          } else if (data.payment_url || data.sandbox_payment_url) {
              // Redirigir a MercadoPago
              const paymentUrl = data.sandbox_payment_url || data.payment_url;
              
              Swal.fire({
                  title: "Redirigiendo a MercadoPago",
                  text: "Serás redirigido a la plataforma de pago segura",
                  icon: "info",
                  timer: 2000,
                  timerProgressBar: true,
                  showConfirmButton: false
              }).then(() => {
                  window.location.href = paymentUrl;
              });
          } else {
              Swal.fire({
                  title: "Error",
                  text: "No se pudo crear la preferencia de pago",
                  icon: "error",
                  confirmButtonText: "OK"
              });
          }
      })
      .catch(error => {
          Swal.fire({
              title: "Error",
              text: "Hubo un problema al procesar tu compra. Por favor intenta nuevamente.",
              icon: "error",
              confirmButtonText: "OK"
          });
          console.error("Error:", error);
      });
  });
</script>
