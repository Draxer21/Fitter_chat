{"version":3,"file":"static/js/577.94f79ad8.chunk.js","mappings":"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","sources":["utils/formatPrice.js","pages/CarritoPage.jsx"],"sourcesContent":["const pesoFormatter = new Intl.NumberFormat(\"es-CL\", {\r\n  style: \"currency\",\r\n  currency: \"CLP\",\r\n  minimumFractionDigits: 0,\r\n  maximumFractionDigits: 0,\r\n});\r\n\r\nexport const formatearPrecio = (valor) => {\r\n  if (valor === null || valor === undefined) {\r\n    return pesoFormatter.format(0);\r\n  }\r\n\r\n  const numero = typeof valor === \"number\" ? valor : Number.parseFloat(valor);\r\n  if (!Number.isFinite(numero)) {\r\n    return pesoFormatter.format(0);\r\n  }\r\n\r\n  const normalizado = Math.round(numero);\r\n  return pesoFormatter.format(normalizado);\r\n};\r\n\r\nexport const formatPrice = formatearPrecio;\r\n","import { useEffect, useState } from \"react\";\r\nimport \"../styles/legacy/carrito/style_carrito.css\";\r\nimport { formatearPrecio } from \"../utils/formatPrice\";\r\nimport { useCart } from \"../contexts/CartContext\";\r\nimport { useAuth } from \"../contexts/AuthContext\";\r\n\r\nexport default function CarritoPage() {\r\n  const { items, total, refresh, addItem, decrementItem, removeItem, clearCart, status, error } = useCart();\r\n  const { isAuthenticated, refresh: refreshAuth } = useAuth();\r\n  const [showLoginPrompt, setShowLoginPrompt] = useState(false);\r\n  const [actionError, setActionError] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    refresh().catch(() => {});\r\n  }, [refresh]);\r\n\r\n  const handleMutation = async (runner) => {\r\n    setActionError(\"\");\r\n    try {\r\n      await runner();\r\n    } catch (err) {\r\n      setActionError(err?.message || \"No se pudo actualizar el carrito.\");\r\n    }\r\n  };\r\n\r\n  const handleInc = (id) => handleMutation(() => addItem(id));\r\n  const handleDec = (id) => handleMutation(() => decrementItem(id));\r\n  const handleRemove = (id) => handleMutation(() => removeItem(id));\r\n  const handleClear = () => handleMutation(() => clearCart());\r\n\r\n  const buy = async () => {\r\n    try {\r\n      let authed = isAuthenticated;\r\n      if (!authed) {\r\n        const result = await refreshAuth().catch(() => null);\r\n        authed = Boolean(result?.auth);\r\n      }\r\n      if (!authed) {\r\n        setShowLoginPrompt(true);\r\n        return;\r\n      }\r\n      \r\n      // Llamar al endpoint de pago con MercadoPago\r\n      setActionError(\"\");\r\n      const response = await fetch('/carrito/pagar', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        credentials: 'include',\r\n        body: JSON.stringify({\r\n          // El backend tomará el nombre y email de la sesión\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        setActionError(data.error || 'Error al procesar la compra');\r\n        return;\r\n      }\r\n\r\n      // Redirigir a MercadoPago\r\n      const paymentUrl = data.sandbox_payment_url || data.payment_url;\r\n      if (paymentUrl) {\r\n        window.location.href = paymentUrl;\r\n      } else {\r\n        setActionError('No se pudo obtener la URL de pago');\r\n      }\r\n\r\n    } catch (err) {\r\n      setActionError(err?.message || 'Error al procesar la compra');\r\n      setShowLoginPrompt(false);\r\n    }\r\n  };\r\n\r\n  const isLoading = status === \"loading\";\r\n  const isUpdating = status === \"updating\";\r\n  const generalError = error?.message || \"\";\r\n  const errorMessage = actionError || generalError;\r\n  const rows = Array.isArray(items) ? items : [];\r\n  const totalValue = Number(total) || 0;\r\n\r\n  return (\r\n    <div className=\"cart-container\">\r\n      <h1 className=\"cart-title\">CARRITO</h1>\r\n\r\n      {isLoading && <div className=\"loading-cart\" role=\"status\" aria-live=\"polite\">Cargando...</div>}\r\n\r\n      {errorMessage && <div className=\"error-cart\" role=\"alert\" aria-live=\"assertive\">{errorMessage}</div>}\r\n\r\n      {!isLoading && !errorMessage && rows.length === 0 && (\r\n        <div className=\"empty-cart\" role=\"status\" aria-live=\"polite\">Sin Productos</div>\r\n      )}\r\n\r\n      {!isLoading && !errorMessage && rows.length > 0 && (\r\n        <>\r\n          {rows.map((v) => (\r\n            <div key={v.producto_id} className=\"cart-item\">\r\n              <img\r\n                src={v.imagen || \"/placeholder.jpg\"}\r\n                alt={v.nombre}\r\n                className=\"cart-item-image\"\r\n              />\r\n              <div className=\"cart-item-details\">\r\n                <div className=\"cart-item-name\">{v.nombre}</div>\r\n                <div className=\"cart-item-price\">\r\n                  Precio unitario: {formatearPrecio(v.precio_unitario)} | Total: {formatearPrecio(v.acumulado)}\r\n                </div>\r\n                <div className=\"cart-item-controls\">\r\n                  <button onClick={() => handleDec(v.producto_id)} className=\"quantity-btn\" disabled={isUpdating}>\r\n                    -\r\n                  </button>\r\n                  <span className=\"quantity-display\">{v.cantidad}</span>\r\n                  <button onClick={() => handleInc(v.producto_id)} className=\"quantity-btn\" disabled={isUpdating}>\r\n                    +\r\n                  </button>\r\n                  <button onClick={() => handleRemove(v.producto_id)} className=\"remove-btn\" disabled={isUpdating}>\r\n                    Eliminar\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ))}\r\n\r\n          <div className=\"cart-summary\">\r\n            <div className=\"cart-total\">Total: {formatearPrecio(totalValue)}</div>\r\n            <div className=\"cart-actions\">\r\n              <button onClick={handleClear} className=\"action-btn clear-btn\" disabled={isUpdating}>\r\n                Limpiar\r\n              </button>\r\n              <button onClick={buy} className=\"action-btn checkout-btn\" disabled={isUpdating}>\r\n                Hacer Compra\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n\r\n      {showLoginPrompt && (\r\n        <>\r\n          <div className=\"modal d-block\" tabIndex={-1} role=\"dialog\" style={{ backgroundColor: \"transparent\" }}>\r\n            <div className=\"modal-dialog modal-dialog-centered\" role=\"document\">\r\n              <div className=\"modal-content\">\r\n                <div className=\"modal-header\">\r\n                  <h5 className=\"modal-title\">Necesitas iniciar sesion</h5>\r\n                  <button type=\"button\" className=\"btn-close\" aria-label=\"Close\" onClick={() => setShowLoginPrompt(false)} />\r\n                </div>\r\n                <div className=\"modal-body\">\r\n                  <p>Para completar la compra debes iniciar sesion. Deseas ir al formulario de inicio de sesion ahora?</p>\r\n                </div>\r\n                <div className=\"modal-footer\">\r\n                  <button type=\"button\" className=\"btn btn-secondary\" onClick={() => setShowLoginPrompt(false)}>\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"btn btn-primary\"\r\n                    onClick={() => {\r\n                      window.location.href = \"/login?next=/carrito\";\r\n                    }}\r\n                  >\r\n                    Ir a Login\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div className=\"modal-backdrop fade show\" style={{ opacity: 0.5 }} />\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":["pesoFormatter","Intl","NumberFormat","style","currency","minimumFractionDigits","maximumFractionDigits","formatearPrecio","valor","undefined","format","numero","Number","parseFloat","isFinite","normalizado","Math","round","CarritoPage","items","total","refresh","addItem","decrementItem","removeItem","clearCart","status","error","useCart","isAuthenticated","refreshAuth","useAuth","showLoginPrompt","setShowLoginPrompt","useState","actionError","setActionError","useEffect","catch","handleMutation","async","runner","err","message","isLoading","isUpdating","generalError","errorMessage","rows","Array","isArray","totalValue","_jsxs","className","children","_jsx","role","length","_Fragment","map","v","src","imagen","alt","nombre","precio_unitario","acumulado","onClick","handleDec","id","producto_id","disabled","cantidad","handleInc","handleRemove","handleClear","authed","result","Boolean","auth","response","fetch","method","headers","credentials","body","JSON","stringify","data","json","ok","paymentUrl","sandbox_payment_url","payment_url","window","location","href","tabIndex","backgroundColor","type","opacity"],"sourceRoot":""}