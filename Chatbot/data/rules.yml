version: "3.1"
rules:

  # ───────── One-turn / FAQ ─────────
  - rule: Agradecimiento
    steps:
      - intent: agradecimiento
      - action: utter_agradecimiento

  - rule: Ayuda
    steps:
      - intent: ayuda
      - action: utter_info_servicios

  - rule: Contacto humano
    steps:
      - intent: contacto_humano
      - action: utter_contacto_humano

  - rule: Horarios
    steps:
      - intent: horarios
      - action: utter_horarios

  - rule: Privacidad
    steps:
      - intent: privacidad
      - action: utter_privacidad

  - rule: Precios y planes
    steps:
      - intent: precios_planes
      - action: utter_precios_planes

  - rule: Ubicación
    steps:
      - intent: ubicacion
      - action: utter_ubicacion

  - rule: Fuera de alcance
    steps:
      - intent: fuera_de_alcance
      - action: utter_fuera_de_alcance

  # ───────── Saludo / Despedida ─────────
  - rule: Saludar
    steps:
      - intent: saludar
      - action: utter_saludar

  - rule: Despedir
    steps:
      - intent: despedir
      - action: utter_despedir

  # ───────── Nutrición (UNA sola regla) ─────────
  - rule: Consejo nutricional (acción)
    steps:
      - intent: consejo_nutricion
      - action: action_consejo_nutricion

  # ───────── Rutina: FORM ─────────
  - rule: Sugerir rutina (activar form)
    steps:
      - intent: sugerir_rutina
      - action: rutina_form
      - active_loop: rutina_form

  - rule: Rutina (submit → generar)
    condition:
      - active_loop: rutina_form
    steps:
      - action: rutina_form
      - active_loop: null
      - action: utter_resumen_rutina
      - action: action_generar_rutina
      # Nota: no definimos reglas post-generación para evitar choques.
  
  - rule: Enviar rutina por correo → pedir contacto
    steps:
      - intent: enviar_rutina_correo
      - action: utter_pedir_contacto

  - rule: Enviar rutina por correo → confirmar con contacto
    steps:
      - action: utter_pedir_contacto
      - intent: informar
      - action: utter_envio_rutina_correo


  # ───────── Triggers directos (opcionales, no confluyentes) ─────────
  - rule: Mostrar rutina en pantalla (directo)
    steps:
      - intent: mostrar_rutina_pantalla
      - action: rutina_form
      - active_loop: rutina_form

  - rule: Enviar rutina por correo (pedir contacto directo)
    steps:
      - intent: enviar_rutina_correo
      - action: utter_pedir_contacto

  # ───────── Progreso y Resumen (higiene) ─────────
  - rule: Registrar progreso
    steps:
      - intent: progreso_registrar
      - action: utter_progreso_registrado

  - rule: Resumen de rutina (a demanda)
    steps:
      - intent: resumen_rutina
      - action: action_resumen_rutina

  # ───────── Reserva: FORM ─────────
  - rule: Crear reserva (activar form)
    steps:
      - intent: crear_reserva
      - action: reserva_form
      - active_loop: reserva_form

  - rule: Crear reserva (submit → confirmar)
    condition:
      - active_loop: reserva_form
    steps:
      - action: reserva_form
      - active_loop: null
      - action: utter_confirmar_reserva

  - rule: Confirmar creación de reserva
    steps:
      - action: utter_confirmar_reserva
      - intent: afirmar
      - action: action_crear_reserva
      - action: utter_reserva_confirmada

  - rule: Cancelar creación de reserva
    steps:
      - action: utter_confirmar_reserva
      - intent: negar
      - action: utter_reserva_cancelada

  # ───────── Consultar / Cancelar reserva (código) ─────────
  - rule: Consultar reserva (pedir código)
    steps:
      - intent: consultar_reserva
      - action: utter_ask_codigo_reserva

  - rule: Consultar reserva (con código)
    steps:
      - slot_was_set:
          - codigo_reserva: true
      - action: action_consultar_reserva
      - action: utter_reserva_estado

  - rule: Cancelar reserva (pedir código)
    steps:
      - intent: cancelar_reserva
      - action: utter_ask_codigo_reserva

  - rule: Cancelar reserva (con código)
    steps:
      - slot_was_set:
          - codigo_reserva: true
      - action: action_cancelar_reserva
      - action: utter_reserva_cancelada

  # ───────── Suscripciones ─────────
  - rule: Suscripción cambio de plan (acción)
    steps:
      - intent: suscripcion_cambio_plan
      - action: action_suscripcion_cambio_plan

  - rule: Suscripción alta
    steps:
      - intent: suscripcion_alta
      - action: utter_suscripcion_alta

  - rule: Suscripción baja
    steps:
      - intent: suscripcion_baja
      - action: utter_suscripcion_baja

  # ───────── Binarios mínimos (silencian warnings) ─────────
  - rule: Afirmación simple
    steps:
      - intent: afirmar
      - action: utter_affirm

  - rule: Negación simple
    steps:
      - intent: negar
      - action: utter_deny

  - rule: Higiene → marcar uso de utter_envio_rutina_correo
    steps:
      - action: utter_envio_rutina_correo
