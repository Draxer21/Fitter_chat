# Nginx perimetral para Fitter (backend Flask + Rasa)

worker_processes auto;
events { worker_connections 1024; }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    keepalive_timeout  65;

    # Rate limit basico para endpoints de chat/NLU
    limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;

    # Upstreams internos
    upstream fitter_backend {
        server backend:5000;
    }
    upstream rasa_api {
        server rasa:5005;
    }
    upstream rasa_actions {
        server rasa-actions:5055;
    }

    server {
        listen 80;
        server_name _;

        client_max_body_size 16m;
        proxy_read_timeout 60s;
        proxy_connect_timeout 5s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header Referrer-Policy no-referrer;

        # API Flask y SPA
        location / {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://fitter_backend;
        }

        # NLU directo a Rasa (opcional)
        location /rasa/ {
            limit_req zone=api burst=10 nodelay;
            rewrite ^/rasa/(.*)$ /$1 break;
            proxy_pass http://rasa_api;
        }

        # Actions SDK (solo interno)
        location /actions/ {
            internal;
            rewrite ^/actions/(.*)$ /$1 break;
            proxy_pass http://rasa_actions;
        }

        # Salud simple
        location = /nginx-health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "ok";
        }
    }
}
